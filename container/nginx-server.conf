#
# Copyright (C) 2016-2023 Martin Cejp
#
# This file is part of ProtoDB.
#
# ProtoDB is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# ProtoDB is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with ProtoDB.  If not, see <http://www.gnu.org/licenses/>.

server {
    listen 10080 default;

    client_max_body_size 108M;

    access_log /var/log/nginx/application.access.log;

    root /var/www/html;
    index /;

    rewrite "^/$"                                       "/bootstrap.php?controller=IndexController&target=index" last;
    rewrite "^/login$"                                  "/bootstrap.php?controller=LoginController&target=login" last;
    rewrite "^/logout$"                                 "/bootstrap.php?controller=LoginController&target=logout" last;

    rewrite "^/buses/([0-9]+)$"                         "/bootstrap.php?controller=BusController&target=index&bus_id=$1" last;
    rewrite "^/buses/([0-9]+)/export-dbc"               "/bootstrap.php?controller=ExportController&target=bus_dbc&bus_id=$1" last;
    rewrite "^/enum-types/new-([0-9]+)$"                "/bootstrap.php?controller=EnumTypeController&target=index&unit_id=$1" last;
    rewrite "^/enum-types/([0-9]+)$"                    "/bootstrap.php?controller=EnumTypeController&target=index&enum_type_id=$1" last;
    rewrite "^/enum-types/([0-9]+)/delete$"             "/bootstrap.php?controller=EnumTypeController&target=delete&enum_type_id=$1" last;
    rewrite "^/enum-types/([0-9]+)/edit$"               "/bootstrap.php?controller=EnumTypeController&target=index&enum_type_id=$1&edit=1" last;
    rewrite "^/messages/new-([0-9]+)$"                  "/bootstrap.php?controller=MessageController&target=index&unit_id=$1" last;
    rewrite "^/messages/([0-9]+)$"                      "/bootstrap.php?controller=MessageController&target=index&message_id=$1" last;
    rewrite "^/messages/([0-9]+)/delete$"               "/bootstrap.php?controller=MessageController&target=delete&message_id=$1" last;
    rewrite "^/messages/([0-9]+)/edit$"                 "/bootstrap.php?controller=MessageController&target=index&message_id=$1&edit=1" last;
    rewrite "^/packages/([0-9]+)$"                      "/bootstrap.php?controller=PackageController&target=view&package_id=$1" last;
    rewrite "^/packages/([0-9]+)/export-dbc$"           "/bootstrap.php?controller=ExportController&target=dbc&package_id=$1" last;
    rewrite "^/packages/([0-9]+)/export-json$"          "/bootstrap.php?controller=ExportController&target=package_json&package_id=$1" last;
    rewrite "^/packages/([0-9]+)/export-json2$"         "/bootstrap.php?controller=ExportController&target=json2_buses_of_package_protodb&package_id=$1" last;
    rewrite "^/units/new-([0-9]+)$"                     "/bootstrap.php?controller=UnitController&target=index&package_id=$1" last;
    rewrite "^/units/([0-9]+)$"                         "/bootstrap.php?controller=UnitController&target=index&unit_id=$1" last;
    rewrite "^/units/([0-9]+)/edit$"                    "/bootstrap.php?controller=UnitController&target=index&unit_id=$1&edit=1" last;
    rewrite "^/units/([0-9]+)/export-dbc"               "/bootstrap.php?controller=ExportController&target=unit_dbc&unit_id=$1" last;
    rewrite "^/units/([0-9]+)/export-json$"             "/bootstrap.php?controller=ExportController&target=json&unit_id=$1" last;
    rewrite "^/units/([0-9]+)/export-tx"                "/bootstrap.php?controller=ExportController&target=tx&unit_id=$1" last;
    rewrite "^/admin-management$"                       "/bootstrap.php?controller=AdminManagement&target=index" last;

    rewrite "^/drc$"                                    "/bootstrap.php?controller=DrcController&target=all" last;
    rewrite "^/drc/incidents/([0-9]+)$"                 "/bootstrap.php?controller=DrcController&target=incident&incident_id=$1" last;
    rewrite "^/packages/([0-9]+)/drc$"                  "/bootstrap.php?controller=DrcController&target=package&package_id=$1" last;
    rewrite "^/units/([0-9]+)/drc$"                     "/bootstrap.php?controller=DrcController&target=unit&unit_id=$1" last;
    rewrite "^/messages/([0-9]+)/drc$"                  "/bootstrap.php?controller=DrcController&target=message&message_id=$1" last;

    rewrite "^/help/changelog$"                         "/bootstrap.php?controller=IndexController&target=changelog" last;

    location / { deny all; }

    location /static/ {
        expires 1h;
        add_header Pragma public;
        add_header Cache-Control "public";
    }

    location = /bootstrap.php {
        fastcgi_pass localhost:9000;
        fastcgi_index /;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PHP_VALUE "error_log=/var/log/nginx/application_php_errors.log";
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        include fastcgi_params;
    }

    location = /api {
        rewrite ^ /api/;
    }

    location /api {
        try_files $uri @api_server;
    }

    location @api_server {
        include uwsgi_params;
        uwsgi_pass unix:/tmp/api-server.sock;
    }
}
